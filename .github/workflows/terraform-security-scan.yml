name: Terraform Security Scan

on:
  pull_request:
    branches: [ master, main ]
  push:
    branches: [ master, main ]
  workflow_dispatch:

env:
  AZURE_RESOURCE_GROUP: pp-rg
  AKS_CLUSTER: pp-fips-cbom-demo
  NAMESPACE: tf-static-scan-demo

jobs:
  terraform-scan:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.5.0

    - name: Download OPA
      run: |
        curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64
        chmod +x opa
        ./opa version

    - name: Generate Terraform Plan
      working-directory: examples
      run: |
        terraform init -backend=false
        terraform plan -out=tfplan.binary
        terraform show -json tfplan.binary > tfplan.json

    - name: Run Security Scan
      working-directory: examples
      run: |
        ../opa eval \
          --data ../policies/azure-storage-misconfigurations.rego \
          --input tfplan.json \
          --format pretty \
          'data.azure.storage.deny'

    - name: Get Violation Summary
      working-directory: examples
      run: |
        ../opa eval \
          --data ../policies/azure-storage-misconfigurations.rego \
          --input tfplan.json \
          --format pretty \
          'data.azure.storage.violation_summary'

    - name: Check for HIGH severity violations
      working-directory: examples
      run: |
        HIGH_COUNT=$(../opa eval \
          --data ../policies/azure-storage-misconfigurations.rego \
          --input tfplan.json \
          --format raw \
          'count([v | v := data.azure.storage.deny[_]; v.severity == "HIGH"])')

        echo "HIGH severity violations: $HIGH_COUNT"

        if [ "$HIGH_COUNT" -gt 0 ]; then
          echo "❌ Found $HIGH_COUNT HIGH severity violations - Pipeline failed"
          exit 1
        else
          echo "✅ No HIGH severity violations found"
        fi

    - name: Upload scan results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: terraform-scan-results
        path: examples/tfplan.json
        retention-days: 30
